<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Zen Feeds | Daily Mindful Moments</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Zen Feeds</h1>
            <p class="subtitle">Daily Mindful Moments</p>
        </header>

        <nav class="category-tabs" id="category-tabs">
            <button class="tab active" data-category="all">All</button>
            <button class="tab" data-category="nature">üåø Nature</button>
            <button class="tab" data-category="food">üçµ Food</button>
            <button class="tab" data-category="travel">üèî Travel</button>
        </nav>

        <main id="feed" class="feed">
            <!-- Posts will be loaded here -->
        </main>
    </div>

    <!-- Fullscreen Gallery -->
    <div id="gallery" class="gallery">
        <div class="gallery-close" onclick="closeGallery()">√ó</div>
        <div class="gallery-counter"><span id="gallery-current">1</span> / <span id="gallery-total">1</span></div>
        <div class="gallery-track" id="gallery-track"></div>
        <div class="gallery-info" id="gallery-info">
            <div class="gallery-title"></div>
            <div class="gallery-author"></div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="back-to-top" class="back-to-top" onclick="scrollToTop()" aria-label="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
    </button>

    <script>
        let feedsData = {};
        let allPosts = [];
        let filteredPosts = []; // Posts filtered by category
        let displayedPosts = []; // Track actually displayed (not errored) posts
        let displayedCount = 0;
        const POSTS_PER_LOAD = 12;
        let isLoading = false;
        let reachedEnd = false;
        let currentCategory = 'all';

        // Gallery state
        let galleryIndex = 0;

        async function loadFeeds() {
            try {
                const response = await fetch('feeds.json');
                feedsData = await response.json();
                allPosts = Object.values(feedsData);
                allPosts.sort(() => Math.random() - 0.5);
                filterByCategory('all');
                setupCategoryTabs();
                setupInfiniteScroll();
                setupBackToTop();
                setupGalleryTouch();
            } catch (error) {
                console.error('Error loading feeds:', error);
            }
        }

        function setupCategoryTabs() {
            const tabs = document.querySelectorAll('.category-tabs .tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterByCategory(tab.dataset.category);
                });
            });
        }

        function filterByCategory(category) {
            currentCategory = category;
            if (category === 'all') {
                filteredPosts = [...allPosts];
            } else {
                filteredPosts = allPosts.filter(post => post.category === category);
            }
            filteredPosts.sort(() => Math.random() - 0.5);
            displayedCount = 0;
            displayedPosts = [];
            reachedEnd = false;
            document.getElementById('feed').innerHTML = '';
            renderMorePosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleImageError(img) {
            const post = img.closest('.post');
            if (post) {
                const id = post.dataset.id;
                displayedPosts = displayedPosts.filter(p => p.id !== id);
                post.remove();
            }
        }

        function handleImageLoad(img) {
            const post = img.closest('.post');
            if (post) {
                const id = post.dataset.id;
                const postData = allPosts.find(p => p.id === id);
                if (postData && !displayedPosts.find(p => p.id === id)) {
                    displayedPosts.push(postData);
                }
            }
        }

        function renderMorePosts() {
            if (isLoading || reachedEnd) return;
            isLoading = true;
            
            const container = document.getElementById('feed');
            const remaining = filteredPosts.length - displayedCount;
            const toLoad = Math.min(POSTS_PER_LOAD, remaining);
            
            if (toLoad <= 0) {
                reachedEnd = true;
                isLoading = false;
                return;
            }
            
            for (let i = 0; i < toLoad; i++) {
                const post = filteredPosts[displayedCount + i];
                
                const article = document.createElement('article');
                article.className = 'post';
                article.dataset.id = post.id;
                article.onclick = () => openGallery(post.id);
                article.innerHTML = `
                    <div class="post-image-link">
                        <img src="${post.url}" class="post-image" alt="${post.title}" loading="lazy" 
                             onerror="handleImageError(this)" onload="handleImageLoad(this)">
                    </div>
                    <div class="post-content">
                        <div class="post-date">by ${post.author}</div>
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-summary">${post.summary}</p>
                    </div>
                `;
                container.appendChild(article);
            }
            
            displayedCount += toLoad;
            isLoading = false;
        }

        // Gallery functions
        function openGallery(id) {
            const idx = displayedPosts.findIndex(p => p.id === id);
            if (idx === -1) return;
            
            galleryIndex = idx;
            const gallery = document.getElementById('gallery');
            const track = document.getElementById('gallery-track');
            
            // Build gallery slides
            track.innerHTML = displayedPosts.map((post, i) => `
                <div class="gallery-slide" data-index="${i}">
                    <img src="${post.url}" alt="${post.title}" loading="${i < idx + 3 ? 'eager' : 'lazy'}">
                </div>
            `).join('');
            
            document.getElementById('gallery-total').textContent = displayedPosts.length;
            
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Scroll to the selected image
            requestAnimationFrame(() => {
                track.scrollTop = idx * window.innerHeight;
                updateGalleryInfo();
            });
        }

        function closeGallery() {
            document.getElementById('gallery').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function updateGalleryInfo() {
            document.getElementById('gallery-current').textContent = galleryIndex + 1;
            const post = displayedPosts[galleryIndex];
            if (post) {
                document.querySelector('.gallery-title').textContent = post.title;
                document.querySelector('.gallery-author').textContent = `by ${post.author}`;
            }
        }

        function galleryPrev() {
            if (galleryIndex > 0) {
                galleryIndex--;
                const track = document.getElementById('gallery-track');
                track.scrollTo({ top: galleryIndex * window.innerHeight, behavior: 'smooth' });
                updateGalleryInfo();
            }
        }

        function galleryNext() {
            if (galleryIndex < displayedPosts.length - 1) {
                galleryIndex++;
                const track = document.getElementById('gallery-track');
                track.scrollTo({ top: galleryIndex * window.innerHeight, behavior: 'smooth' });
                updateGalleryInfo();
            }
            // Auto-load more when near the end
            if (galleryIndex >= displayedPosts.length - 3) {
                loadMoreToGallery();
            }
        }

        function loadMoreToGallery() {
            if (isLoading || reachedEnd) return;
            
            const remaining = filteredPosts.length - displayedCount;
            if (remaining <= 0) {
                reachedEnd = true;
                return;
            }
            
            isLoading = true;
            const toLoad = Math.min(POSTS_PER_LOAD, remaining);
            const track = document.getElementById('gallery-track');
            const feedContainer = document.getElementById('feed');
            
            for (let i = 0; i < toLoad; i++) {
                const post = filteredPosts[displayedCount + i];
                
                // Add to gallery
                const slide = document.createElement('div');
                slide.className = 'gallery-slide';
                slide.dataset.index = displayedPosts.length;
                slide.innerHTML = `<img src="${post.url}" alt="${post.title}">`;
                track.appendChild(slide);
                
                // Add to main feed too
                const article = document.createElement('article');
                article.className = 'post';
                article.dataset.id = post.id;
                article.onclick = () => openGallery(post.id);
                article.innerHTML = `
                    <div class="post-image-link">
                        <img src="${post.url}" class="post-image" alt="${post.title}" loading="lazy" 
                             onerror="handleImageError(this)" onload="handleImageLoad(this)">
                    </div>
                    <div class="post-content">
                        <div class="post-date">by ${post.author}</div>
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-summary">${post.summary}</p>
                    </div>
                `;
                feedContainer.appendChild(article);
                
                displayedPosts.push(post);
            }
            
            displayedCount += toLoad;
            document.getElementById('gallery-total').textContent = displayedPosts.length;
            isLoading = false;
        }

        function setupGalleryTouch() {
            const gallery = document.getElementById('gallery');
            const track = document.getElementById('gallery-track');
            
            // Use native scroll with scroll-snap - listen for scroll end to update index
            let scrollTimeout;
            track.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const newIndex = Math.round(track.scrollTop / window.innerHeight);
                    if (newIndex !== galleryIndex) {
                        galleryIndex = newIndex;
                        updateGalleryInfo();
                        // Auto-load more when near the end
                        if (galleryIndex >= displayedPosts.length - 3) {
                            loadMoreToGallery();
                        }
                    }
                }, 100);
            }, { passive: true });
            
            // Keyboard navigation (up/down arrows)
            document.addEventListener('keydown', (e) => {
                if (!gallery.classList.contains('active')) return;
                if (e.key === 'ArrowUp') galleryPrev();
                if (e.key === 'ArrowDown') galleryNext();
                if (e.key === 'Escape') closeGallery();
            });
        }

        function setupInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if (isLoading || reachedEnd) return;
                
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const docHeight = document.documentElement.scrollHeight;
                
                if (scrollTop + windowHeight >= docHeight - 500) {
                    renderMorePosts();
                }
            });
        }

        function setupBackToTop() {
            const btn = document.getElementById('back-to-top');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 500) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            });
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        loadFeeds();
    </script>
</body>
</html>
